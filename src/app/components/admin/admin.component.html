<div class="min-h-screen bg-zinc-950 pb-24">
    <!-- Header -->
    <div class="bg-gradient-to-r from-emerald-900/40 to-zinc-900 border-b border-zinc-800">
        <div class="max-w-5xl mx-auto px-4 py-6 md:py-8">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <div>
                    <h1 class="text-2xl md:text-4xl font-bold text-white mb-1 md:mb-2">
                        üéµ Panel de <span class="text-emerald-400">Administraci√≥n</span>
                    </h1>
                    <p class="text-zinc-400 text-sm md:text-base">Sube canciones a Firebase Storage y Firestore</p>
                </div>
                <button (click)="logout()"
                    class="self-start sm:self-auto px-4 py-2 md:px-6 md:py-3 bg-red-600/20 hover:bg-red-600/30 border border-red-600/50 text-red-400 font-medium rounded-lg transition-all gap-2 text-sm md:text-base inline-flex items-center">
                    <i class='bx bx-log-out text-lg md:text-xl'></i>
                    <span>Cerrar Sesi√≥n</span>
                </button>
            </div>
        </div>
    </div>

    <div class="max-w-5xl mx-auto px-4 py-6 md:py-8">
        <!-- Upload Form -->
        <div class="bg-zinc-900/50 backdrop-blur-md rounded-2xl border border-zinc-800 p-4 md:p-6 lg:p-8">
            <h2 class="text-xl md:text-2xl font-bold text-white mb-4 md:mb-6">Subir Canciones</h2>

            <form (ngSubmit)="uploadSong()" class="space-y-4 md:space-y-6">

                <!-- Artist Selection -->
                <div class="bg-zinc-800/30 rounded-xl p-4 md:p-6 border border-zinc-700/50">
                    <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                        <i class='bx bx-user-circle text-emerald-400'></i>
                        Artista
                    </h3>

                    <div class="space-y-4">
                        <div>
                            <label class="text-sm font-medium text-zinc-300 mb-2 inline-block">
                                Seleccionar Artista *
                            </label>
                            <select (change)="onArtistChange($event)" [(ngModel)]="songData.artistId"
                                name="artistSelect"
                                class="w-full px-4 py-3 bg-zinc-800 border border-zinc-700 rounded-lg text-white focus:border-emerald-500 focus:ring-2 focus:ring-emerald-500/20 transition-all text-sm md:text-base">
                                <option value="">-- Selecciona un artista --</option>
                                @for (artist of artists(); track artist.id) {
                                <option [value]="artist.id">{{ artist.name }}</option>
                                }
                                <option value="new" class="text-emerald-400">+ Crear Nuevo Artista</option>
                            </select>
                        </div>

                        <!-- New Artist Form -->
                        @if (showNewArtistForm()) {
                        <div
                            class="bg-emerald-500/10 border border-emerald-500/30 rounded-lg p-4 space-y-3 animate-fade-in">
                            <p class="text-emerald-400 text-sm font-medium flex items-center gap-2">
                                <i class='bx bx-plus-circle'></i>
                                Crear Nuevo Artista
                            </p>
                            <input type="text" [(ngModel)]="newArtistName" name="newArtist"
                                placeholder="Nombre del artista"
                                class="w-full px-4 py-2.5 bg-zinc-800 border border-zinc-700 rounded-lg text-white placeholder-zinc-500 focus:border-emerald-500 focus:ring-2 focus:ring-emerald-500/20 transition-all text-sm">
                            <div class="flex gap-2">
                                <button type="button" (click)="createNewArtist()"
                                    class="flex-1 px-4 py-2 bg-emerald-600 hover:bg-emerald-500 text-white font-medium rounded-lg transition-all text-sm">
                                    Crear Artista
                                </button>
                                <button type="button" (click)="cancelNewArtist()"
                                    class="px-4 py-2 bg-zinc-700 hover:bg-zinc-600 text-white font-medium rounded-lg transition-all text-sm">
                                    Cancelar
                                </button>
                            </div>
                        </div>
                        }
                    </div>
                </div>

                <!-- Album Selection (only if artist is selected) -->
                @if (songData.artistId && !showNewArtistForm()) {
                <div class="bg-zinc-800/30 rounded-xl p-4 md:p-6 border border-zinc-700/50 animate-fade-in">
                    <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                        <i class='bx bx-album text-emerald-400'></i>
                        √Ålbum
                    </h3>

                    <div class="space-y-4">
                        <div>
                            <label class="text-sm font-medium text-zinc-300 mb-2 inline-block">
                                Seleccionar √Ålbum
                            </label>
                            <select (change)="onAlbumChange($event)" [(ngModel)]="songData.albumId" name="albumSelect"
                                class="w-full px-4 py-3 bg-zinc-800 border border-zinc-700 rounded-lg text-white focus:border-emerald-500 focus:ring-2 focus:ring-emerald-500/20 transition-all text-sm md:text-base">
                                <option value="none">Sin √Ålbum (Canciones Sueltas)</option>
                                @for (album of albums(); track album.id) {
                                <option [value]="album.id">{{ album.name }} ({{ album.year }})</option>
                                }
                                <option value="new" class="text-emerald-400">+ Crear Nuevo √Ålbum</option>
                            </select>
                        </div>

                        <!-- New Album Form -->
                        @if (showNewAlbumForm()) {
                        <div
                            class="bg-emerald-500/10 border border-emerald-500/30 rounded-lg p-4 space-y-3 animate-fade-in">
                            <p class="text-emerald-400 text-sm font-medium flex items-center gap-2">
                                <i class='bx bx-plus-circle'></i>
                                Crear Nuevo √Ålbum para {{ songData.artistName }}
                            </p>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <input type="text" [(ngModel)]="newAlbumName" name="newAlbum"
                                    placeholder="Nombre del √°lbum"
                                    class="w-full px-4 py-2.5 bg-zinc-800 border border-zinc-700 rounded-lg text-white placeholder-zinc-500 focus:border-emerald-500 focus:ring-2 focus:ring-emerald-500/20 transition-all text-sm">
                                <input type="number" [(ngModel)]="songData.year" name="albumYear" placeholder="A√±o"
                                    class="w-full px-4 py-2.5 bg-zinc-800 border border-zinc-700 rounded-lg text-white placeholder-zinc-500 focus:border-emerald-500 focus:ring-2 focus:ring-emerald-500/20 transition-all text-sm">
                            </div>
                            <div class="flex gap-2">
                                <button type="button" (click)="createNewAlbum()"
                                    class="flex-1 px-4 py-2 bg-emerald-600 hover:bg-emerald-500 text-white font-medium rounded-lg transition-all text-sm">
                                    Crear √Ålbum
                                </button>
                                <button type="button" (click)="cancelNewAlbum()"
                                    class="px-4 py-2 bg-zinc-700 hover:bg-zinc-600 text-white font-medium rounded-lg transition-all text-sm">
                                    Cancelar
                                </button>
                            </div>
                        </div>
                        }
                    </div>
                </div>
                }

                <!-- Song Info -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                    <!-- Title (Only visible if single file or no file) -->
                    @if (audioFiles.length <= 1) { <div>
                        <label class="text-sm font-medium text-zinc-300 mb-2 inline-block">
                            T√≠tulo de la Canci√≥n *
                        </label>
                        <input type="text" [(ngModel)]="songData.title" name="title" required
                            class="w-full px-4 py-3 bg-zinc-800 border border-zinc-700 rounded-lg text-white placeholder-zinc-500 focus:border-emerald-500 focus:ring-2 focus:ring-emerald-500/20 transition-all text-sm md:text-base"
                            placeholder="Ej: Tit√≠ Me Pregunt√≥">
                </div>
                } @else {
                <div class="flex items-center p-4 bg-emerald-500/10 border border-emerald-500/30 rounded-lg">
                    <i class='bx bx-check-double text-emerald-400 text-2xl mr-3'></i>
                    <div>
                        <p class="text-emerald-400 font-bold">Modo Carga Masiva</p>
                        <p class="text-zinc-400 text-sm">Se usar√°n los nombres de archivo como t√≠tulos</p>
                    </div>
                </div>
                }

                <!-- Genre -->
                <div>
                    <label class="text-sm font-medium text-zinc-300 mb-2 inline-block">
                        G√©nero
                    </label>
                    <select (change)="onGenreChange($event)" [(ngModel)]="songData.genre" name="genre"
                        class="w-full px-4 py-3 bg-zinc-800 border border-zinc-700 rounded-lg text-white focus:border-emerald-500 focus:ring-2 focus:ring-emerald-500/20 transition-all text-sm md:text-base">
                        <option value="">Seleccionar g√©nero</option>
                        @for (genre of genres(); track genre) {
                        <option [value]="genre">{{ genre }}</option>
                        }
                        <option value="new" class="text-emerald-400">+ Crear Nuevo G√©nero</option>
                    </select>

                    <!-- New Genre Form -->
                    @if (showNewGenreForm()) {
                    <div
                        class="mt-2 bg-emerald-500/10 border border-emerald-500/30 rounded-lg p-3 space-y-2 animate-fade-in">
                        <input type="text" [(ngModel)]="newGenre" name="newGenre" placeholder="Nombre del g√©nero"
                            class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-lg text-white placeholder-zinc-500 focus:border-emerald-500 text-sm">
                        <div class="flex gap-2">
                            <button type="button" (click)="createNewGenre()"
                                class="flex-1 px-3 py-1.5 bg-emerald-600 hover:bg-emerald-500 text-white font-medium rounded text-xs">
                                Crear
                            </button>
                            <button type="button" (click)="cancelNewGenre()"
                                class="px-3 py-1.5 bg-zinc-700 hover:bg-zinc-600 text-white font-medium rounded text-xs">
                                Cancelar
                            </button>
                        </div>
                    </div>
                    }
                </div>

                <!-- Year -->
                <div>
                    <label class="text-sm font-medium text-zinc-300 mb-2 inline-block">
                        A√±o
                    </label>
                    <input type="number" [(ngModel)]="songData.year" name="year"
                        class="w-full px-4 py-3 bg-zinc-800 border border-zinc-700 rounded-lg text-white placeholder-zinc-500 focus:border-emerald-500 focus:ring-2 focus:ring-emerald-500/20 transition-all text-sm md:text-base"
                        placeholder="2024">
                </div>

                <!-- Duration (auto-filled) -->
                @if (audioFiles.length <= 1) { <div>
                    <label class="text-sm font-medium text-zinc-300 mb-2 inline-block">
                        Duraci√≥n
                    </label>
                    <input type="text" [(ngModel)]="songData.duration" name="duration" readonly
                        class="w-full px-4 py-3 bg-zinc-800/50 border border-zinc-700 rounded-lg text-zinc-400 cursor-not-allowed text-sm md:text-base"
                        placeholder="Auto-detectado">
        </div>
        }
    </div>

    <!-- File Uploads -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 pt-2 md:pt-4">
        <!-- Audio File -->
        <div>
            <label class="text-sm font-medium text-zinc-300 mb-2 inline-block">
                Archivos de Audio (MP3) *
            </label>
            <div class="relative">
                <input type="file" accept="audio/*" multiple (change)="onAudioFileSelected($event)" class="hidden"
                    #audioInput>
                <button type="button" (click)="audioInput.click()"
                    class="w-full px-4 py-3 bg-zinc-800 border-2 border-dashed border-zinc-700 rounded-lg text-zinc-400 hover:border-emerald-500 hover:text-emerald-400 transition-all gap-2 text-sm md:text-base inline-flex items-center justify-center">
                    <i class='bx bx-music text-lg md:text-xl'></i>
                    <span class="truncate">
                        {{ audioFiles.length > 0 ? audioFiles.length + ' archivos seleccionados' : 'Click para
                        seleccionar MP3s' }}
                    </span>
                </button>
            </div>
            @if (audioPreview) {
            <audio [src]="audioPreview" controls class="w-full mt-3 rounded-lg"></audio>
            }
        </div>

        <!-- Cover Image -->
        <div>
            <label class="text-sm font-medium text-zinc-300 mb-2 inline-block">
                Imagen de Portada *
            </label>
            <div class="relative">
                <input type="file" accept="image/*" (change)="onImageFileSelected($event)" class="hidden" #imageInput>
                <button type="button" (click)="imageInput.click()"
                    class="w-full px-4 py-3 bg-zinc-800 border-2 border-dashed border-zinc-700 rounded-lg text-zinc-400 hover:border-emerald-500 hover:text-emerald-400 transition-all gap-2 text-sm md:text-base inline-flex items-center justify-center">
                    <i class='bx bx-image text-lg md:text-xl'></i>
                    <span class="truncate">{{ imageFile ? imageFile.name : 'Click para seleccionar imagen' }}</span>
                </button>
            </div>
            @if (imagePreview) {
            <div class="mt-3 rounded-lg overflow-hidden border border-zinc-700">
                <img [src]="imagePreview" alt="Preview" class="w-full h-48 object-cover">
            </div>
            }
        </div>
    </div>

    <!-- PREVIEW TABLE -->
    @if (previewSongs().length > 0) {
    <div class="mt-6 bg-zinc-800/30 rounded-xl border border-zinc-700/50 overflow-hidden animate-fade-in">
        <div class="p-4 bg-zinc-800/50 border-b border-zinc-700 flex justify-between items-center">
            <h3 class="font-bold text-white flex items-center gap-2">
                <i class='bx bx-list-ul text-emerald-400'></i>
                Vista Previa de Carga ({{ previewSongs().length }} canciones)
            </h3>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-left text-sm text-zinc-400">
                <thead class="bg-zinc-800/50 text-xs uppercase font-medium text-zinc-500">
                    <tr>
                        <th class="px-4 py-3">#</th>
                        <th class="px-4 py-3">Portada</th>
                        <th class="px-4 py-3">T√≠tulo Detectado</th>
                        <th class="px-4 py-3">Archivo</th>
                        <th class="px-4 py-3">Duraci√≥n</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-zinc-700/50">
                    @for (song of previewSongs(); track $index) {
                    <tr class="hover:bg-zinc-800/30 transition-colors">
                        <td class="px-4 py-3">{{ $index + 1 }}</td>
                        <td class="px-4 py-3">
                            @if (imagePreview) {
                            <img [src]="imagePreview" class="w-8 h-8 rounded object-cover">
                            } @else {
                            <div class="w-8 h-8 rounded bg-zinc-700 flex items-center justify-center">
                                <i class='bx bx-music'></i>
                            </div>
                            }
                        </td>
                        <td class="px-4 py-3 font-medium text-white">{{ song.title }}</td>
                        <td class="px-4 py-3 text-xs">{{ song.file.name }}</td>
                        <td class="px-4 py-3">{{ song.duration }}</td>
                    </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
    }

    <!-- Progress Bar -->
    @if (uploadProgress().uploading || uploadProgress().message) {
    <div class="mt-4 md:mt-6 p-4 bg-zinc-800/50 rounded-lg border border-zinc-700">
        @if (uploadProgress().uploading) {
        <div class="mb-2">
            <div class="justify-between text-sm text-zinc-400 mb-1 inline-flex w-full">
                <span>{{ uploadProgress().message }}</span>
                <span>{{ uploadProgress().progress }}%</span>
            </div>
            <div class="w-full bg-zinc-700 rounded-full h-2 overflow-hidden">
                <div class="bg-gradient-to-r from-emerald-500 to-emerald-400 h-full transition-all duration-300"
                    [style.width.%]="uploadProgress().progress"></div>
            </div>
        </div>
        }
        @if (!uploadProgress().uploading && uploadProgress().message) {
        <p class="text-center font-medium" [class.text-emerald-400]="uploadProgress().message.includes('‚úÖ')"
            [class.text-red-400]="uploadProgress().message.includes('‚ùå')">
            {{ uploadProgress().message }}
        </p>
        }
    </div>
    }

    <!-- Submit Button -->
    <div class="flex-col sm:flex-row gap-3 md:gap-4 pt-2 md:pt-4 inline-flex w-full">
        <button type="submit" [disabled]="uploadProgress().uploading"
            class="flex-1 px-4 py-3 md:px-6 md:py-4 bg-gradient-to-r from-emerald-600 to-emerald-500 text-black font-bold rounded-lg hover:from-emerald-500 hover:to-emerald-400 transition-all transform hover:-translate-y-1 hover:shadow-lg hover:shadow-emerald-500/20 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none gap-2 text-sm md:text-base inline-flex items-center justify-center">
            <i class='bx bx-cloud-upload text-lg md:text-xl'></i>
            <span>{{ uploadProgress().uploading ? 'Subiendo...' : (audioFiles.length > 1 ? 'Subir ' + audioFiles.length
                + ' Canciones' : 'Subir Canci√≥n') }}</span>
        </button>

        <button type="button" (click)="resetForm()" [disabled]="uploadProgress().uploading"
            class="px-4 py-3 md:px-6 md:py-4 bg-zinc-800 text-white font-medium rounded-lg hover:bg-zinc-700 transition-all border border-zinc-700 disabled:opacity-50 disabled:cursor-not-allowed text-sm md:text-base">
            Limpiar
        </button>
    </div>
    </form>
</div>

<!-- Instructions -->
<div class="mt-6 md:mt-8 bg-zinc-900/30 backdrop-blur-sm rounded-xl border border-zinc-800 p-4 md:p-6">
    <h3 class="text-base md:text-lg font-bold text-white mb-3 md:mb-4 gap-2 inline-flex items-center">
        <i class='bx bx-info-circle text-emerald-400'></i>
        Instrucciones de Carga Masiva
    </h3>
    <ul class="space-y-2 text-xs md:text-sm text-zinc-400">
        <li class="gap-2 inline-flex items-start">
            <i class='bx bx-check text-emerald-400 mt-0.5'></i>
            <span>Puedes seleccionar m√∫ltiples archivos MP3 a la vez.</span>
        </li>
        <li class="gap-2 inline-flex items-start">
            <i class='bx bx-check text-emerald-400 mt-0.5'></i>
            <span>La imagen de portada seleccionada se aplicar√° a TODAS las canciones.</span>
        </li>
        <li class="gap-2 inline-flex items-start">
            <i class='bx bx-check text-emerald-400 mt-0.5'></i>
            <span>El t√≠tulo se detecta autom√°ticamente del nombre del archivo (ej: "01. Cancion.mp3" ->
                "Cancion").</span>
        </li>
        <li class="gap-2 inline-flex items-start">
            <i class='bx bx-check text-emerald-400 mt-0.5'></i>
            <span>Revisa la tabla de vista previa antes de subir para asegurar que todo est√© correcto.</span>
        </li>
    </ul>
</div>
</div>
</div>